<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í†µí•© ë·°ì–´: ì˜ìƒ, ì›¹ìº , 3D ëª¨ë¸</title>
    <style>
        /* ê¸°ë³¸ ì„¤ì • */
        body { 
            margin: 0; 
            font-family: Arial, sans-serif;
            overflow: auto; /* í•„ìš” ì‹œ ìŠ¤í¬ë¡¤ í—ˆìš© */
            min-width: 1000px; /* ìµœì†Œ ë„ˆë¹„ */
        }

        /* ì „ì²´ ì»¨í…Œì´ë„ˆ: ìƒë‹¨ (ì˜ìƒ/ì›¹ìº )ê³¼ í•˜ë‹¨ (3D)ì„ í¬í•¨ */
        .main-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100vh; /* í™”ë©´ ë†’ì´ ì „ì²´ ì‚¬ìš© */
        }

        /* --- 1. ìƒë‹¨ ì„¹ì…˜: ì˜ìƒ ë° ì›¹ìº  (í™”ë©´ ë†’ì´ì˜ 50% ì°¨ì§€) --- */
        .top-section {
            display: flex;
            width: 1000px; /* ê³ ì • ë„ˆë¹„ */
            height: 500px; /* ê³ ì • ë†’ì´ */
            margin: 0 auto; /* ì¤‘ì•™ ì •ë ¬ */
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        /* ìƒë‹¨ ì™¼ìª½ íŒ¨ë„: ì˜ìƒ */
        .left-panel {
            width: 500px; 
            height: 500px; 
            overflow: hidden; 
            background-color: #f0f0f0; 
            flex-shrink: 0;
        }
        #my-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ìƒë‹¨ ì˜¤ë¥¸ìª½ íŒ¨ë„: ì›¹ìº  */
        .right-panel {
            position: relative;
            width: 500px; 
            height: 500px; 
            background-color: #333333; 
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }
        #webcam-feed {
            width: 500px; 
            height: 500px; 
            object-fit: cover;
            transform: scaleX(-1); /* ê±°ìš¸ ëª¨ë“œ */
            display: none;
        }
        .loading-text {
            color: white;
            font-size: 1.2em;
            text-align: center;
        }

        /* --- 2. í•˜ë‹¨ ì„¹ì…˜: 3D ë·°ì–´ (ë‚¨ì€ ê³µê°„ ì „ì²´ ì°¨ì§€) --- */
        .bottom-section {
            flex-grow: 1; /* ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€ */
            min-height: 300px; /* ìµœì†Œ ë†’ì´ ë³´ì¥ */
            overflow: hidden;
            position: relative;
        }
        /* Three.js ìº”ë²„ìŠ¤ê°€ í•˜ë‹¨ ì„¹ì…˜ ì•ˆì— ë“¤ì–´ê°€ë„ë¡ ì„¤ì • */
        #three-canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <div class="main-container">
        <div class="top-section">
            <div class="left-panel">
                <video id="my-video" autoplay loop muted playsinline>
                    <source src="base.mp4" type="video/mp4">
                    ë¸Œë¼ìš°ì €ëŠ” ë¹„ë””ì˜¤ íƒœê·¸ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                </video>
            </div>
            <div class="right-panel">
                <div id="loading-message" class="loading-text">
                    ì›¹ìº  ì ‘ê·¼ì„ ìš”ì²­ ì¤‘ì…ë‹ˆë‹¤...
                </div>
                <video id="webcam-feed" autoplay playsinline></video>
            </div>
        </div>

        <div class="bottom-section" id="bottom-section">
            </div>
    </div>


    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // ==========================================================
        // 1. ìƒë‹¨ ì„¹ì…˜ (ì˜ìƒ/ì›¹ìº ) ë¡œì§
        // ==========================================================

        const videoElement = document.getElementById('webcam-feed');
        const loadingMessage = document.getElementById('loading-message');
        const myVideo = document.getElementById('my-video');

        // A. ì™¼ìª½ ì˜ìƒ ì¬ìƒ ì‹œë„
        if (myVideo) {
            myVideo.play().catch(error => {
                console.log("ìë™ ì¬ìƒì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ í´ë¦­í•´ ì£¼ì„¸ìš”.");
                document.addEventListener('click', () => {
                    myVideo.play().catch(e => console.log("ì¬ìƒ ì‹¤íŒ¨:", e));
                }, { once: true });
            });
        }

        // B. ì˜¤ë¥¸ìª½ ì›¹ìº  ì‹œì‘
        async function startWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                loadingMessage.style.display = 'none';
                videoElement.style.display = 'block';
                videoElement.srcObject = stream;
            } catch (err) {
                console.error("ì›¹ìº  ì ‘ê·¼ ê¶Œí•œ ê±°ë¶€ ë˜ëŠ” ì˜¤ë¥˜ ë°œìƒ:", err);
                loadingMessage.innerText = "ì›¹ìº  ì ‘ê·¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.";
                loadingMessage.style.color = '#ff6b6b';
            }
        }
        window.onload = startWebcam;


        // ==========================================================
        // 2. í•˜ë‹¨ ì„¹ì…˜ (3D ëª¨ë¸) ë¡œì§
        // ==========================================================

        let intersectedObject = null;Â 
        let isDragging = false;Â  Â  Â  Â 
        let previousMousePosition = { x: 0, y: 0 };Â 
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        
        // ğŸŒŸ ëª¨ë¸ ì„¤ì •
        const modelsToLoad = [
            { name: 'shoes.glb', scale: 10 },Â 
            { name: 'bag.glb', scale: 7 },
            { name: 'ball.glb', scale: 5 },
            { name: 'book.glb', scale: 10 },Â 
            { name: 'close.glb', scale: 5 },
            { name: 'glasses.glb', scale: 20 },Â 
            { name: 'guard.glb', scale: 10 },
            { name: 'persimmon.glb', scale: 20 },
        ];
        const FIXED_POSITION_Y = -4.0;
        const FIXED_POSITION_Z = 0.0;
        const MODEL_SPACING_X = 3.0;

        // --- 3D ê¸°ë³¸ ìš”ì†Œ ì„¤ì • ---
        const bottomSection = document.getElementById('bottom-section');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xdddddd); // 3D ë°°ê²½ìƒ‰: ë°ì€ íšŒìƒ‰

        // ìº”ë²„ìŠ¤ë¥¼ ë‹´ëŠ” í•˜ë‹¨ ì„¹ì…˜ì˜ í¬ê¸°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¹´ë©”ë¼ ì„¤ì •
        const camera = new THREE.PerspectiveCamera(
            50, 
            bottomSection.clientWidth / bottomSection.clientHeight, 
            0.1, 
            1000
        );
        camera.position.set(0, 0, 15);Â 

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(bottomSection.clientWidth, bottomSection.clientHeight);
        bottomSection.appendChild(renderer.domElement);Â 


        // --- ì¡°ëª… ì„¤ì • ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
        directionalLight.position.set(5, 10, 7).normalize();
        scene.add(directionalLight);

        // --- ì»¨íŠ¸ë¡¤ ì„¤ì • ---
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.target.set(0, FIXED_POSITION_Y, 0); 
        controls.enablePan = false;Â  Â  Â 
        controls.enableRotate = false;Â Â 
        controls.maxDistance = 20;Â  Â  Â Â 
        controls.minDistance = 5;Â  Â  Â  Â 


        // --- GLB ëª¨ë¸ ë¡œë“œ ---
        const loader = new GLTFLoader();Â 
        const modelCount = modelsToLoad.length;
        const startX = -((modelCount - 1) * MODEL_SPACING_X) / 2;Â 

        modelsToLoad.forEach((modelInfo, index) => {
            loader.load(
                modelInfo.name,
                function (gltf) {
                    const model = gltf.scene;
                    model.position.x = startX + (index * MODEL_SPACING_X);Â 
                    model.position.y = FIXED_POSITION_Y;Â 
                    model.position.z = FIXED_POSITION_Z;Â 
                    model.scale.set(modelInfo.scale, modelInfo.scale, modelInfo.scale);
                    scene.add(model);
                },
                undefined,Â 
                function (error) {
                    console.error(`ëª¨ë¸ ë¡œë“œ ì—ëŸ¬: ${modelInfo.name}`, error);
                }
            );
        });


        // --- ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ (ê°œë³„ íšŒì „) ---
        renderer.domElement.addEventListener('mousedown', onMouseDown, false);
        renderer.domElement.addEventListener('mousemove', onMouseMove, false);
        renderer.domElement.addEventListener('mouseup', onMouseUp, false);

        function onMouseDown(event) {
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(scene.children, true);Â 

            if (intersects.length > 0) {
                let target = intersects[0].object;
                while (target.parent && target.parent !== scene) {
                    target = target.parent;
                }
                if (target.parent === scene) {
                    intersectedObject = target;
                    isDragging = true;
                    previousMousePosition.x = event.clientX;
                    previousMousePosition.y = event.clientY;
                    controls.enabled = false; 
                }
            }
        }

        function onMouseMove(event) {
            if (!isDragging || !intersectedObject) return;
            const deltaX = event.clientX - previousMousePosition.x;
            intersectedObject.rotation.y += deltaX * 0.01;Â 
            previousMousePosition.x = event.clientX;
        }

        function onMouseUp(event) {
            isDragging = false;
            intersectedObject = null;
            controls.enabled = true; 
        }


        // --- ë Œë”ë§ ë£¨í”„ ë° ì°½ í¬ê¸° ë³€ê²½ ì²˜ë¦¬ ---
        function animate() {
            requestAnimationFrame(animate);Â 
            controls.update();Â 
            renderer.render(scene, camera);Â 
        }
        animate();

        window.addEventListener('resize', () => {
            // í•˜ë‹¨ ì„¹ì…˜ì˜ ìƒˆ í¬ê¸°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const newWidth = bottomSection.clientWidth;
            const newHeight = bottomSection.clientHeight;

            // 3D ë·°ì–´ í¬ê¸° ì¡°ì •
            camera.aspect = newWidth / newHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(newWidth, newHeight);
        });

    </script>
</body>
</html>
